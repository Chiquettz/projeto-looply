<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recicla Looply - Looply</title>
<link rel="stylesheet" href="style.css">
<style>
  /* CSS EXCLUSIVO DO JOGO */
  .game-wrapper {
    max-width: 900px; margin: 0 auto; padding: 1rem;
    display: flex; flex-direction: column; gap: 2rem;
    touch-action: none; /* Evita que a tela fa√ßa scroll ao tentar jogar */
  }
  .game-hud {
    display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;
  }
  .hud-item {
    background: var(--bg3); border: 2px solid var(--border); padding: 0.6rem 1.2rem;
    border-radius: 12px; font-family: "Nunito", sans-serif; font-weight: 800;
  }
  .hud-item span { color: var(--green); font-size: 1.2rem; }
  
  .play-area {
    height: 300px; background: var(--bg2); border: 2px dashed var(--border);
    border-radius: 16px; position: relative; overflow: hidden;
  }
  .trash-item {
    position: absolute; font-size: 3.5rem; cursor: grab; user-select: none;
    transition: transform 0.2s; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    z-index: 10; display: flex; align-items: center; justify-content: center;
  }
  .trash-item:active { cursor: grabbing; transform: scale(1.1); }
  
  .bins-container {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem;
  }
  @media (min-width: 768px) {
    .bins-container { grid-template-columns: repeat(6, 1fr); }
  }
  
  .bin-zone {
    height: 120px; border-radius: 12px; border: 3px solid transparent;
    display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
    padding-bottom: 0.8rem; color: #fff; font-weight: 900; font-size: 0.75rem;
    transition: transform 0.2s, border-color 0.2s; position: relative;
  }
  .bin-zone::before { content: "‚ôªÔ∏è"; font-size: 2.2rem; opacity: 0.3; margin-bottom: 0.5rem; }
  .bin-zone.drag-over { transform: scale(1.08); border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.4); }
  
  /* Cores das Lixeiras */
  .bin-zone[data-type="papel"] { background-color: #3b82f6; } 
  .bin-zone[data-type="plastico"] { background-color: #ef4444; } 
  .bin-zone[data-type="vidro"] { background-color: #10b981; } 
  .bin-zone[data-type="metal"] { background-color: #eab308; } 
  .bin-zone[data-type="organico"] { background-color: #8B4513; } 
  .bin-zone[data-type="eletronico"] { background-color: #f97316; } 
  
  .game-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.85);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100; border-radius: 16px; color: #fff; text-align: center; padding: 1rem;
  }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-logo" onclick="goTo('landing')">
    <img class="logo-img" src="imgs/looply-logo.png" alt="Looply">
  </div>
  <div class="nav-links">
    <button class="nav-link" id="nl-home" onclick="goTo('landing')">In√≠cio</button>
    <button class="nav-link" id="nl-trails" onclick="reqTrails()">Trilhas</button>
    <button class="nav-link" id="nl-profile" style="display:none" onclick="goTo('profile')">Meu Perfil</button>
  </div>
  <div class="nav-right">
    <div class="xp-badge" id="xp-badge" style="display:none">
      <div class="xp-dot"></div><span id="xp-disp">0 XP</span>
    </div>
    <button class="theme-btn" id="tbtn" onclick="toggleTheme()">üåô</button>
    <button class="btn-sm" id="btn-login" onclick="openAuth('login')">Entrar</button>
    <button class="btn-outline" id="btn-signup" onclick="openAuth('signup')">Cadastrar</button>
    <button class="btn-sm" id="btn-logout" style="display:none" onclick="logout()">Sair</button>
    <button class="hamburger" id="hbg" onclick="toggleMenu()"><span></span><span></span><span></span></button>
  </div>
</nav>

<!-- MOBILE MENU -->
<div class="mob-menu" id="mob-menu">
  <button class="nav-link" onclick="goTo('landing');closeMenu()">üè† In√≠cio</button>
  <button class="nav-link" onclick="reqTrails();closeMenu()">üåø Trilhas</button>
  <button class="nav-link" id="ml-profile" style="display:none" onclick="goTo('profile');closeMenu()">üë§ Meu Perfil</button>
  <div class="mob-divider"></div>
  <div class="mob-btns" id="m-auth">
    <button class="btn-outline" onclick="openAuth('login');closeMenu()">Entrar</button>
    <button class="btn-sm" onclick="openAuth('signup');closeMenu()">Cadastrar</button>
  </div>
  <div class="mob-btns" id="m-user" style="display:none">
    <div class="xp-badge"><div class="xp-dot"></div><span id="m-xp">0 XP</span></div>
    <button class="btn-outline" onclick="logout()">Sair</button>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div class="overlay" id="auth-ov">
  <div class="modal">
    <button class="modal-x" onclick="closeAuth()">‚úï</button>
    <div class="modal-logo"><img class="logo-img" src="imgs/looply-logo.png" alt="Looply"></div>
    <div id="auth-content"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="pg-pad">
  <div class="td-hdr" style="text-align: center;">
    <button class="back-btn" onclick="goTo('trails')">‚Üê Voltar para Trilhas</button>
    <h2>üéÆ Super Recicla</h2>
    <p>Arraste rapidamente os res√≠duos para a lixeira correta antes que o tempo acabe!</p>
    <div class="game-hud">
      <div class="hud-item">‚è±Ô∏è Tempo: <span id="timer-display">45</span>s</div>
      <div class="hud-item">‚≠ê Pontos: <span id="score-display">0</span></div>
      <div class="hud-item">üî• Combo: <span id="combo-display">x1</span></div>
    </div>
  </div>

  <div class="game-wrapper">
    <div class="play-area" id="play-area">
      <div class="game-overlay" id="start-overlay">
        <h3 style="font-family:'Nunito',sans-serif; font-size: 1.8rem; margin-bottom:1rem; color:var(--green)">Pronto para o desafio?</h3>
        <button class="btn-primary" onclick="startGame()">Iniciar Jogo</button>
      </div>
    </div>

    <div class="bins-container">
      <div class="bin-zone" data-type="papel">PAPEL</div>
      <div class="bin-zone" data-type="plastico">PL√ÅSTICO</div>
      <div class="bin-zone" data-type="vidro">VIDRO</div>
      <div class="bin-zone" data-type="metal">METAL</div>
      <div class="bin-zone" data-type="organico">ORG√ÇNICO</div>
      <div class="bin-zone" data-type="eletronico">ELETR√îNICO</div>
    </div>
  </div>
</div>

<script src="app.js"></script>

<script>
const itemDB = [
  { emoji: 'üì∞', type: 'papel' }, { emoji: 'üì¶', type: 'papel' }, { emoji: 'üßª', type: 'papel' },
  { emoji: 'ü•§', type: 'plastico' }, { emoji: 'üõçÔ∏è', type: 'plastico' }, { emoji: 'üß¥', type: 'plastico' },
  { emoji: 'üçæ', type: 'vidro' }, { emoji: 'ü´ô', type: 'vidro' }, { emoji: 'üç∑', type: 'vidro' },
  { emoji: 'ü•´', type: 'metal' }, { emoji: 'üìé', type: 'metal' }, { emoji: 'üîë', type: 'metal' },
  { emoji: 'üçé', type: 'organico' }, { emoji: 'üçå', type: 'organico' }, { emoji: 'üçÇ', type: 'organico' },
  { emoji: 'üì±', type: 'eletronico' }, { emoji: 'üîã', type: 'eletronico' }, { emoji: 'üíª', type: 'eletronico' }
];

let score = 0, time = 45, combo = 1;
let gameInterval, spawnInterval;
const playArea = document.getElementById('play-area');

// Vari√°veis de suporte para o Touch Mobile
let activeTouchItem = null;
let offsetX = 0; let offsetY = 0;

// 1. L√ìGICA DE DRAG & DROP PARA PC (MOUSE)
document.querySelectorAll('.bin-zone').forEach(bin => {
  bin.addEventListener('dragover', e => { e.preventDefault(); bin.classList.add('drag-over'); });
  bin.addEventListener('dragenter', e => { e.preventDefault(); bin.classList.add('drag-over'); });
  bin.addEventListener('dragleave', () => { bin.classList.remove('drag-over'); });
  
  bin.addEventListener('drop', e => {
    e.preventDefault();
    bin.classList.remove('drag-over');
    const id = e.dataTransfer.getData('text/plain');
    const draggedEl = document.getElementById(id);
    if (draggedEl) checkMatch(draggedEl, bin);
  });
});

// 2. L√ìGICA DE DRAG & DROP PARA MOBILE (TOUCH)
function handleTouchStart(e) {
  activeTouchItem = e.target;
  const touch = e.touches[0];
  const rect = activeTouchItem.getBoundingClientRect();
  
  // Pega a diferen√ßa entre onde o dedo tocou e o topo/esquerda do item
  offsetX = touch.clientX - rect.left;
  offsetY = touch.clientY - rect.top;
  
  activeTouchItem.style.transition = 'none';
  activeTouchItem.style.zIndex = 1000;
  activeTouchItem.style.transform = 'scale(1.1)';
}

function handleTouchMove(e) {
  if (!activeTouchItem) return;
  e.preventDefault(); // Impede a tela de rolar
  
  const touch = e.touches[0];
  const areaRect = playArea.getBoundingClientRect();
  
  // Atualiza a posi√ß√£o do lixo seguindo o dedo
  let newX = touch.clientX - areaRect.left - offsetX;
  let newY = touch.clientY - areaRect.top - offsetY;
  activeTouchItem.style.left = newX + 'px';
  activeTouchItem.style.top = newY + 'px';

  // Esconde o item rapidinho para descobrir qual lixeira est√° embaixo do dedo
  activeTouchItem.style.visibility = 'hidden';
  const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  activeTouchItem.style.visibility = 'visible';

  // Gerencia o efeito de 'Hover' na lixeira
  document.querySelectorAll('.bin-zone').forEach(b => b.classList.remove('drag-over'));
  if (elemBelow) {
    const bin = elemBelow.closest('.bin-zone');
    if (bin) bin.classList.add('drag-over');
  }
}

function handleTouchEnd(e) {
  if (!activeTouchItem) return;
  const touch = e.changedTouches[0];
  
  // Descobre em qual lixeira o dedo soltou
  activeTouchItem.style.visibility = 'hidden';
  const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  activeTouchItem.style.visibility = 'visible';
  
  document.querySelectorAll('.bin-zone').forEach(b => b.classList.remove('drag-over'));
  const bin = elemBelow ? elemBelow.closest('.bin-zone') : null;

  if (bin) {
    checkMatch(activeTouchItem, bin);
  } else {
    // Se soltar fora de uma lixeira, reseta o visual
    activeTouchItem.style.transition = 'transform 0.2s';
    activeTouchItem.style.transform = 'scale(1)';
  }
  
  activeTouchItem.style.zIndex = 10;
  activeTouchItem = null;
}

// 3. L√ìGICA DE VERIFICA√á√ÉO E PONTUA√á√ÉO (Usada por PC e Mobile)
function checkMatch(item, bin) {
  const expectedType = bin.getAttribute('data-type');
  const actualType = item.getAttribute('data-type');

  if (expectedType === actualType) {
    score += (10 * combo);
    combo++;
    item.remove();
    showToast('‚úÖ +' + (10 * (combo-1)) + ' pts');
  } else {
    score = Math.max(0, score - 20);
    combo = 1;
    showToast('‚ùå Errou! -20 pts');
    item.style.transition = 'transform 0.2s';
    item.style.transform = 'scale(1)'; // Devolve o tamanho
  }
  updateHud();
}

// 4. MEC√ÇNICAS PRINCIPAIS DO JOGO
function startGame() {
  document.getElementById('start-overlay').style.display = 'none';
  playArea.innerHTML = ''; 
  score = 0; time = 45; combo = 1;
  updateHud();

  for(let i=0; i<4; i++) spawnTrash();

  gameInterval = setInterval(() => {
    time--;
    updateHud();
    if (time <= 0) endGame();
  }, 1000);

  spawnInterval = setInterval(() => {
    if (document.querySelectorAll('.trash-item').length < 12) spawnTrash();
  }, 1200);
}

function spawnTrash() {
  const item = itemDB[Math.floor(Math.random() * itemDB.length)];
  const el = document.createElement('div');
  el.className = 'trash-item';
  el.textContent = item.emoji;
  el.setAttribute('data-type', item.type);
  el.draggable = true;
  el.id = 'trash_' + Math.random().toString(36).substr(2, 9);
  
  const maxX = playArea.clientWidth - 70;
  const maxY = playArea.clientHeight - 70;
  el.style.left = Math.floor(Math.random() * maxX) + 'px';
  el.style.top = Math.floor(Math.random() * maxY) + 'px';

  // Eventos de PC (Mouse)
  el.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', el.id);
    setTimeout(() => el.style.opacity = '0.4', 0);
  });
  el.addEventListener('dragend', () => el.style.opacity = '1');

  // Eventos de Mobile (Touch)
  el.addEventListener('touchstart', handleTouchStart, {passive: false});
  el.addEventListener('touchmove', handleTouchMove, {passive: false});
  el.addEventListener('touchend', handleTouchEnd);

  playArea.appendChild(el);
}

function updateHud() {
  document.getElementById('timer-display').textContent = time;
  document.getElementById('score-display').textContent = score;
  document.getElementById('combo-display').textContent = 'x' + combo;
}

function endGame() {
  clearInterval(gameInterval);
  clearInterval(spawnInterval);
  playArea.innerHTML = ''; 
  
  const xpGained = Math.floor(score / 5);
  
  const endOverlay = document.createElement('div');
  endOverlay.className = 'game-overlay';
  endOverlay.innerHTML = `
    <h3 style="font-family:'Nunito',sans-serif; font-size: 2rem; color:var(--amber)">Tempo Esgotado!</h3>
    <p style="font-size: 1.2rem; margin: 1rem 0;">Voc√™ marcou ${score} pontos.</p>
    <p style="font-size: 1.5rem; color: var(--green); font-weight: 800;">XP Ganho: +${xpGained} XP</p>
    <button class="btn-primary" style="margin-top: 1.5rem;" onclick="goTo('trails')">Voltar √†s Trilhas</button>
  `;
  playArea.appendChild(endOverlay);

  const state = getState();
  state.totalXP += xpGained;
  saveState(state);
  setTimeout(()=> syncXP(), 500);
}
</script>
</body>
</html>